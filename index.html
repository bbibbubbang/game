<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>용사식당 타이쿤</title>
<style>
:root{--bg:#222;--fg:#fff;--accent:#5C7CFA;}
body{margin:0;background:#000;display:flex;justify-content:center;align-items:center;height:100vh;color:var(--fg);overflow:hidden;}
body.high{--bg:#000;--fg:#fff;--accent:#FFD700;}
#wrap{position:relative;width:360px;height:640px;background:var(--bg);color:var(--fg);transform-origin:top left;}
#game{position:absolute;left:0;top:0;width:360px;height:320px;background:#333;}
#ui{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;}
.topbar{position:absolute;top:0;left:0;width:100%;height:40px;background:#111;display:flex;justify-content:space-around;align-items:center;font-size:14px;pointer-events:auto;}
.progress{width:100px;height:8px;background:#444;border-radius:4px;overflow:hidden;}
.progress div{height:100%;width:0%;background:var(--accent);}
#main{position:absolute;top:40px;bottom:120px;left:0;right:0;display:flex;justify-content:center;align-items:center;pointer-events:auto;}
#tabs{position:absolute;bottom:0;left:0;width:100%;height:120px;background:#111;display:flex;flex-direction:column;pointer-events:auto;}
.tab-buttons{display:flex;height:40px;}
.tab-buttons button{flex:1;}
.tab-content{flex:1;overflow-y:auto;}
.card{border:1px solid #555;margin:4px;padding:4px;border-radius:4px;font-size:14px;}
.card button{width:100%;margin-top:4px;height:30px;}
button{background:var(--accent);color:#fff;border:none;border-radius:4px;font-size:14px;}
.hide{display:none;}
#toast{position:absolute;left:50%;bottom:130px;transform:translateX(-50%);background:#000;color:#fff;padding:4px 8px;border-radius:4px;opacity:0;transition:opacity .3s;font-size:14px;}
#tutorial{position:absolute;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;text-align:center;font-size:18px;}
</style>
</head>
<body>
<div id="wrap">
<canvas id="game" width="360" height="320"></canvas>
<div id="ui">
<div class="topbar"><div id="coin">0</div><div id="cps">0/s</div><div class="progress"><div id="prog"></div></div></div>
<div id="main"><button id="cookBtn" style="width:120px;height:120px;font-size:32px;">🍲</button></div>
<div id="tabs">
<div class="tab-buttons">
<button data-tab="up">업그레이드</button>
<button data-tab="fa">설비/직원</button>
<button data-tab="re">연구/홍보</button>
<button data-tab="set">설정</button>
</div>
<div id="tab-up" class="tab-content"></div>
<div id="tab-fa" class="tab-content hide"></div>
<div id="tab-re" class="tab-content hide"></div>
<div id="tab-set" class="tab-content hide">
<label><input type="checkbox" id="contrast"> 고대비 모드</label><br>
<label><input type="checkbox" id="debug"> 디버그 x100</label><br>
<button id="saveBtn">즉시 저장</button>
<button id="loadBtn">즉시 불러오기</button>
<button data-skip="60">+1m</button>
<button data-skip="600">+10m</button>
<button data-skip="3600">+1h</button>
<button id="adBtn">광고 보기</button>
<button id="iapBtn">인앱 결제</button>
<button id="resetBtn">리셋</button>
</div>
</div>
<div id="toast"></div>
<div id="tutorial"></div>
</div>
</div>
<script>
// 논리 해상도
const LOGICAL={w:360,h:640};

// 상태 객체
let state={
 coins:0,
 ingredients:0,
 upgrades:{ingredient:0,chef:0,promo:0,auto:0},
 lastUpdate:0,
 cps:0,
 lastSave:Date.now(),
 debug:false,
 lastTime:Date.now()
};

// 업그레이드 정의
const defs={
 up:[
  {id:"ingredient",name:"재료 공급",desc:"재료/sec +100%",base:10,growth:1.15,effect:1}
 ],
 fa:[
  {id:"chef",name:"용사 요리사",desc:"요리 속도 +50%",base:50,growth:1.17,effect:0.5},
  {id:"auto",name:"자동조리기",desc:"요리 속도 +200%",base:500,growth:1.25,effect:2,unlock:()=>state.upgrades.ingredient>=5}
 ],
 re:[
  {id:"promo",name:"홍보",desc:"판매가 +20%",base:100,growth:1.2,effect:0.2}
 ]
};

// UI 참조
const wrap=document.getElementById("wrap");
const coinEl=document.getElementById("coin");
const cpsEl=document.getElementById("cps");
const progEl=document.getElementById("prog");
const tabButtons=document.querySelectorAll(".tab-buttons button");
const tabContents={
 up:document.getElementById("tab-up"),
 fa:document.getElementById("tab-fa"),
 re:document.getElementById("tab-re"),
 set:document.getElementById("tab-set")
};
const cookBtn=document.getElementById("cookBtn");
const toastEl=document.getElementById("toast");
const tutorialEl=document.getElementById("tutorial");

// 숫자 포맷
function fmt(n){if(n>=1e9)return(n/1e9).toFixed(1)+"B";if(n>=1e6)return(n/1e6).toFixed(1)+"M";if(n>=1e3)return(n/1e3).toFixed(1)+"K";return n.toFixed(0);}

// 비용 계산
function cost(def,lvl){return Math.ceil(def.base*Math.pow(def.growth,lvl));}

// 카드 렌더
function renderCards(){
 ["up","fa","re"].forEach(tab=>{
  const div=tabContents[tab]; div.innerHTML="";
  defs[tab].forEach(def=>{
   if(def.unlock&&!def.unlock())return;
   const lvl=state.upgrades[def.id]||0;
   const c=cost(def,lvl);
   const card=document.createElement("div");
   card.className="card";
   card.innerHTML=`<b>${def.name} Lv.${lvl}</b><br>${def.desc}<br>다음 비용: ${fmt(c)}`;
   const btn=document.createElement("button");
   btn.textContent="구매";
   btn.onclick=()=>buy(def.id,def);
   card.appendChild(btn);
   div.appendChild(card);
  });
 });
}

// 구매 처리
function buy(id,def){
 const lvl=state.upgrades[id]||0;
 the=cost(def,lvl);
 if(state.coins>=the){
  state.coins-=the;
  state.upgrades[id]=lvl+1;
  vibrate(50);
  save();
  showToast("구매 완료");
  renderCards();
 }
}

// 진동
function vibrate(ms){if(navigator.vibrate)navigator.vibrate(ms);}

// UI 갱신
function updateUI(){
 coinEl.textContent=fmt(state.coins)+" 💰";
 cpsEl.textContent=fmt(state.cps)+"/s";
 const target=Math.pow(10,Math.floor(Math.log10(state.coins+10))+1);
 progEl.style.width=((state.coins%target)/target*100)+"%";
}

// 저장
function save(){
 state.lastTime=Date.now();
 localStorage.setItem("ysSave",JSON.stringify(state));
 state.lastSave=Date.now();
}

// 불러오기
function load(){
 const s=localStorage.getItem("ysSave");
 if(s){try{state={...state,...JSON.parse(s)}}catch(e){}}
}

// 오프라인 수익 계산
function offline(){
 const now=Date.now();
 const diff=Math.min(now-(state.lastTime||now),8*3600*1000);
 const gain=(state.cps||1)*(diff/1000)*0.5;
 if(gain>0){state.coins+=gain;showToast(`오프라인 수익 +${fmt(gain)}`);}
 state.lastTime=now;
}

// 메인 루프
let last=performance.now();
let accum=0,gainCoins=0;
function loop(t){
 const dt=(t-last)/1000; last=t;
 const mult=state.debug?100:1;
 const ingRate=(1+state.upgrades.ingredient*1)*mult;
 state.ingredients+=ingRate*dt;
 const cookRate=(1+state.upgrades.chef*0.5+state.upgrades.auto*2)*mult;
 const price=1*(1+state.upgrades.promo*0.2);
 const cook=Math.min(state.ingredients,cookRate*dt);
 state.ingredients-=cook;
 const coins=cook*price;
 state.coins+=coins;
 gainCoins+=coins;
 accum+=dt;
 if(accum>=1){
  state.cps=gainCoins/accum;
  gainCoins=0;accum=0;
  updateUI();
 }
 requestAnimationFrame(loop);
}

// 요리 버튼
cookBtn.addEventListener("click",()=>{state.ingredients+=1;vibrate(20);});

// 탭 전환
tabButtons.forEach(btn=>btn.addEventListener("click",()=>{
 const id=btn.dataset.tab;
 Object.keys(tabContents).forEach(k=>tabContents[k].classList.toggle("hide",k!==id));
}));

// 토스트 표시
let toastTimer;
function showToast(msg){
 toastEl.textContent=msg;
 toastEl.style.opacity=1;
 clearTimeout(toastTimer);
 toastTimer=setTimeout(()=>toastEl.style.opacity=0,2000);
}

// 레터박스 스케일
function resize(){
 const scale=Math.min(window.innerWidth/LOGICAL.w,window.innerHeight/LOGICAL.h);
 wrap.style.transform=`scale(${scale})`;
 wrap.style.margin=`${(window.innerHeight-LOGICAL.h*scale)/2}px ${(window.innerWidth-LOGICAL.w*scale)/2}px`;
}
window.addEventListener("resize",resize);

// 설정 이벤트
document.getElementById("contrast").addEventListener("change",e=>document.body.classList.toggle("high",e.target.checked));
document.getElementById("debug").addEventListener("change",e=>state.debug=e.target.checked);
document.querySelectorAll("[data-skip]").forEach(btn=>btn.onclick=()=>{state.lastTime-=btn.dataset.skip*1000;offline();updateUI();});
document.getElementById("saveBtn").onclick=()=>{save();showToast("저장됨");};
document.getElementById("loadBtn").onclick=()=>{load();renderCards();showToast("불러옴");updateUI();};
document.getElementById("resetBtn").onclick=()=>{if(confirm("리셋?")){localStorage.removeItem("ysSave");location.reload();}};
document.getElementById("adBtn").onclick=()=>showToast("준비중");
document.getElementById("iapBtn").onclick=()=>showToast("준비중");

// 자동 저장
setInterval(save,10000);

// 튜토리얼
tutorialEl.textContent="화면 중앙을 탭하면 요리가 준비돼요! (터치)";
tutorialEl.addEventListener("pointerdown",()=>{tutorialEl.style.display="none";});

// 초기 실행
load();
offline();
renderCards();
resize();
updateUI();
save();
requestAnimationFrame(loop);

// 캔버스 간단 연출
const ctx=document.getElementById("game").getContext("2d");
function draw(){
 ctx.clearRect(0,0,360,320);
 ctx.fillStyle="#444";
 ctx.fillRect(80,120,200,100); // 테이블
 ctx.font="40px sans-serif";
 ctx.fillText("🍽️",160,190);
 requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
